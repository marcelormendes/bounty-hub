generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output = "./diagram.md"      // Set filename to .md
  outputFormat = "markdown"   // Set format to markdown
  theme = "dark"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id        String   @id @default(uuid())
  name      String
  website   String?
  users     User[]
  bounties  Bounty[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id                   String    @id
  firstName            String
  lastName             String
  role                 UserRole  @default(DEVELOPER)
  bio                  String?
  githubLogin          String? @unique
  portfolioUrl         String?
  stripeCustomerId     String?
  stripeConnectAccountId String?
  client              Client?  @relation(fields: [clientId], references: [id])
  clientId            String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  clients      Client[]
  claims       BountyClaim[]
  assigned     Bounty[]      @relation("AssignedBounties")
  created      Bounty[]      @relation("CreatedBounties")
  payments     Payment[]
}

model Bounty {
  id          uuid      @id @default(uuid())
  clientId    uuid
  assigneeId  uuid?
  title       String
  description String
  reward      Decimal    @db.Decimal(10,2)
  status      BountyStatus @default(OPEN) // OPEN → CLAIMED → IN_PROGRESS → COMPLETED → APPROVED → PAID
  labels      String[]   @db.VarChar(32)  // tags / skills
  githubIssueUrl String  @unique
  githubPrUrl    String?
  attachments Json?
  deadline    DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([status, clientId])
}


model BountyClaim {
  id         uuid @id @default(uuid())
  bountyId   uuid
  userId     uuid
  status     ClaimStatus  @default(PENDING) // PENDING → ACCEPTED / DECLINED / EXPIRED / WITHDRAWN
  expiresAt  DateTime     // set to now() + 24h
  createdAt  DateTime     @default(now())

  @@unique([bountyId, userId])          // one claim per dev per bounty
  @@index([status, expiresAt])
  @@index([userId, createdAt])          // quota checks
}

model Payment {
  id         String        @id @default(uuid())
  bounty     Bounty        @relation(fields: [bountyId], references: [id])
  bountyId   String
  user       User          @relation(fields: [userId], references: [id])
  userId     String
  amount     Decimal
  status     PaymentStatus
  stripeId   String?
  createdAt  DateTime      @default(now())
  paidAt     DateTime?
}

enum Tier { FREE PREMIUM_10 PREMIUM_20 }

model User {
  …
  tier          Tier     @default(FREE)
  weeklyClaims  Int      @default(0)
  claimsResetAt DateTime @default(date_trunc('week', now()) + interval '1 week')
}


enum UserRole {
  CLIENT
  DEVELOPER
  DESIGNER
  ADMIN
}

enum BountyStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  APPROVED
  REJECTED
  PAID
}

enum ClaimStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}